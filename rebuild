#!/bin/sh -eu

CFLAGS='-g -O0 -D__tb_debug__ -DDEBUG -pipe -fno-omit-frame-pointer'

for arg; do
	case "$arg" in
		c|clean) for x in build; do rm -rf "$x"; echo - "$x"; done;; 
		d|debug) "$0"; gdb ./build/app;;
		r|run)   "$0"; ./build/app < ex.r;;
		*) echo >&2 WAT: "$@"; exit 1;;
	esac
done

[ $# -eq 0 ] || exit 0

trace() { echo >&2 "$@"; "$@"; }
mark() { touch -m -t 0001010000 "$1"; }
deps() { shift; ${CPP:-cpp} ${CFLAGS} -MM -MG "$@" | tr -d '\n\\'; }
dk() { ok "$@" $(deps "$@"); }
ok() {
	[ -f "$1" ] || { mark "$1"; return 1; }
	for d; do [ ! -f "$d" -o "$1" -ef "$d" -o "$1" -nt "$d" ] || { mark "$1"; return 1; }; done;
}

CC() { dk "$@" || { ${CC:-cc} ${CFLAGS:-} -c -o "$@"; echo c "$1"; } }
LD() { ok "$@" || { ${CC:-cc} ${CFLAGS:-} ${LDFLAGS:-} -o "$@"; echo l "$1"; } }
PG() { ok "$@" || ( cd build/; ./packcc -o parser ../"$2"; echo g "$1"; ) }
CP() { ok "$@" || { cp "$2" "$1"; echo + "$1"; } }

mkdir -p build/

CFLAGS="$CFLAGS -Isrc -Ibuild"

CC build/test.o   src/test.c     &
LD build/packcc   external/packcc/src/packcc.c
PG build/parser.c src/parser.peg

wait

LD build/test build/test.o       &
CC build/main.o src/main.c       &
CC build/parser.o build/parser.c

wait

./build/test >/dev/null || ./build/test

LD build/app build/main.o build/parser.o 


